<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline' https://cdn.jsdelivr.net; img-src data: https:; connect-src 'none'; font-src 'self' data:;"
    />
    <title>Python Flowchart</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100vh;
        width: 100vw;
        background-color: var(--vscode-editor-background, #ffffde);
        color: var(--vscode-editor-foreground, #000000);
        cursor: default;
        font-family: var(
          --vscode-font-family,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif
        );
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .mermaid .clickable {
        cursor: pointer;
      }
      #tooltip {
        position: fixed;
        display: none;
        padding: 10px 15px;
        background-color: var(--vscode-side-bar-background, #252526);
        border: 1px solid var(--vscode-widget-border, #303030);
        border-radius: 6px;
        font-family: var(--vscode-font-family);
        font-size: var(--vscode-font-size);
        color: var(--vscode-editor-foreground);
        z-index: 100;
        max-width: 400px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      #tooltip h4 {
        margin-top: 0;
        border-bottom: 1px solid var(--vscode-foreground);
        padding-bottom: 4px;
      }
      #tooltip p {
        margin-bottom: 0;
      }
      .checkbox-container {
        margin-bottom: 15px;
        padding: 8px;
        background-color: var(--vscode-input-background, #3c3c3c);
        border-radius: 4px;
        border: 1px solid var(--vscode-input-border, #3c3c3c);
      }
      .checkbox-container label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .checkbox-container input[type="checkbox"] {
        margin: 0;
      }
      .mermaid {
        text-align: center;
        margin: 0;
        padding: 20px;
        min-height: 200px;
        width: 100%;
        max-width: 95vw;
        overflow: visible;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
      }

      .mermaid svg {
        max-width: 90%;
        width: auto !important;
        height: auto !important;
        min-height: 200px !important;
        max-height: 40vh !important;
        display: block;
        margin: 0 auto;
        transform-origin: center center;
      }

      #content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .regenerate-button-container {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--vscode-editor-background, #ffffde);
        padding: 10px 0;
        border-bottom: 1px solid var(--vscode-widget-border, #303030);
        width: 100%;
        text-align: center;
        flex-shrink: 0;
      }
    </style>
  </head>
  <body>
    <div id="tooltip"></div>

    <div id="content">
      <div class="regenerate-button-container">
        <button id="regenerateBtn" style="
          background-color: var(--vscode-button-background, #007acc);
          color: var(--vscode-button-foreground, #ffffff);
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          font-family: var(--vscode-font-family);
          font-size: 14px;
        ">🔄 Regenerate Flowchart</button>
      </div>
      <div class="mermaid" id="mermaidContainer">
        <!-- DIAGRAM_PLACEHOLDER (diagram arrives via postMessage) -->
      </div>
    </div>

    <!-- Mermaid library -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      // State variables
      let tooltipData = {};
      let lastClickedNodeId = null;

      // DOM elements
      let mermaidContainer = document.getElementById("mermaidContainer");
      const tooltipDiv = document.getElementById("tooltip");
      const regenerateBtn = document.getElementById("regenerateBtn");

      // VS Code API for communication
      let vscode;
      if (typeof acquireVsCodeApi === "function") {
        vscode = acquireVsCodeApi();
      }

      // Regenerate flowchart function
      function regenerateFlowchart() {
        console.log('Regenerate button clicked');
        if (vscode) {
          console.log('VS Code API available, sending regenerate command');
          regenerateBtn.disabled = true;
          regenerateBtn.textContent = "⏳ Processing...";
          
          // Send message to extension to regenerate the entire flowchart
          vscode.postMessage({
            command: 'regenerateComplete'
          });
        } else {
          console.error('VS Code API not available');
          regenerateBtn.disabled = false;
        }
      }

      // Event listener for regenerate button
      regenerateBtn.addEventListener('click', regenerateFlowchart);

      // Handle messages from extension
      window.addEventListener('message', event => {
        const message = event.data;
        console.log('Received message from extension:', message);
        
        switch (message.command) {
          case 'updateFlowchart':
            console.log('Updating flowchart with:', message.diagram);
            // Clear the container first
            mermaidContainer.innerHTML = '';
            
            console.log('message.diagram', message.diagram);  
            // Re-render with Mermaid
            mermaid.render('mermaidContainer', message.diagram).then(({ svg }) => {
              console.log('Mermaid rendering successful, updating container');
              
              try {
                // Create a new container instead of updating the existing one
                const newContainer = document.createElement('div');
                newContainer.className = 'mermaid';
                newContainer.id = 'mermaidContainer';
                newContainer.innerHTML = svg;
                
                // Ensure the new container is visible
                newContainer.style.display = 'flex';
                newContainer.style.visibility = 'visible';
                newContainer.style.opacity = '1';
                
                // Replace the old container with the new one
                const oldContainer = document.getElementById('mermaidContainer');
                if (oldContainer && oldContainer.parentNode) {
                  oldContainer.parentNode.replaceChild(newContainer, oldContainer);
                  console.log('Container replaced successfully');
                } else {
                  console.warn('Could not find old container or parent node');
                  // Fallback: append to parent if replacement fails
                  const parentElement = document.querySelector('#content');
                  if (parentElement) {
                    parentElement.appendChild(newContainer);
                    console.log('Container appended as fallback');
                  }
                }
                
                // Update the reference
                mermaidContainer = newContainer;
                
                // Verify the container is accessible
                const verifyContainer = document.querySelector('.mermaid#mermaidContainer');
                if (verifyContainer) {
                  console.log('Container verification successful:', verifyContainer);
                } else {
                  console.error('Container verification failed - container not found by selector');
                }
                
                // Check if the diagram is empty
                console.log('newContainer.innerHTML', newContainer.innerHTML);
                
                // Mark clickable nodes again
                setTimeout(markClickableNodes, 300);
              } catch (error) {
                console.error('Error during container replacement:', error);
                // Fallback: update existing container content
                if (mermaidContainer) {
                  mermaidContainer.innerHTML = svg;
                  mermaidContainer.style.display = 'flex';
                  mermaidContainer.style.visibility = 'visible';
                }
              }
            }).catch(error => {
              console.error('Error rendering updated flowchart:', error);
              try {
                // Fallback: show the raw diagram
                const newContainer = document.createElement('div');
                newContainer.className = 'mermaid';
                newContainer.id = 'mermaidContainer';
                newContainer.innerHTML = `<pre style="color: var(--vscode-editor-foreground); padding: 20px; text-align: left; overflow-x: auto;">${message.diagram}</pre>`;
                newContainer.style.display = 'flex';
                newContainer.style.visibility = 'visible';
                
                const oldContainer = document.getElementById('mermaidContainer');
                if (oldContainer && oldContainer.parentNode) {
                  oldContainer.parentNode.replaceChild(newContainer, oldContainer);
                } else {
                  // Fallback: append to parent if replacement fails
                  const parentElement = document.querySelector('#content');
                  if (parentElement) {
                    parentElement.appendChild(newContainer);
                  }
                }
                
                mermaidContainer = newContainer;
              } catch (fallbackError) {
                console.error('Fallback container creation also failed:', fallbackError);
              }
            });
            break;
            
          case 'updateTooltipData':
            console.log('Updating tooltip data:', message.tooltipData);
            tooltipData = message.tooltipData || {};
            break;
            
          case 'regenerationComplete':
            console.log('Regeneration completed successfully');
            // Re-enable the button
            regenerateBtn.disabled = false;
            regenerateBtn.textContent = "🔄 Regenerate Flowchart";
            
            // Debug container state after regeneration
            setTimeout(() => {
              console.log('Container state after regeneration:');
              debugContainerState();
            }, 100);
            break;
            
          case 'regenerationError':
            console.error('Regeneration error:', message.error);
            regenerateBtn.disabled = false;
            regenerateBtn.textContent = "🔄 Regenerate Flowchart";
            // Show error in the container
            mermaidContainer.innerHTML = `<div style="color: var(--vscode-errorForeground, #f48771); padding: 20px; text-align: center;">Error: ${message.error}</div>`;
            break;
        }
      });

      // Tooltip functions
      window.setClickedNode = function (nodeId) {
        lastClickedNodeId = nodeId;
      };

      // Debug function to check container state
      function debugContainerState() {
        console.log('=== Container State Debug ===');
        console.log('mermaidContainer variable:', mermaidContainer);
        console.log('mermaidContainer by ID:', document.getElementById('mermaidContainer'));
        console.log('mermaidContainer by class:', document.querySelector('.mermaid'));
        console.log('mermaidContainer by selector:', document.querySelector('.mermaid#mermaidContainer'));
        console.log('All mermaid elements:', document.querySelectorAll('.mermaid'));
        console.log('Content div:', document.querySelector('#content'));
        console.log('=============================');
      }

      // Expose debug function globally for testing
      window.debugContainerState = debugContainerState;

      function markClickableNodes() {
        if (!tooltipData || Object.keys(tooltipData).length === 0) return;

        Object.keys(tooltipData).forEach((nodeId) => {
          const el = document.getElementById(nodeId);
          if (el) {
            el.classList.add("clickable");
            el.style.cursor = "pointer";
          }
        });
      }

      // Click event listener for tooltips
      document.addEventListener(
        "click",
        function (e) {
          const clickedElement = e.target.closest(".clickable");
          if (clickedElement && lastClickedNodeId) {
            const content = tooltipData[lastClickedNodeId];
            if (content) {
              tooltipDiv.innerHTML = content;
              const rect = clickedElement.getBoundingClientRect();
              tooltipDiv.style.left = rect.right + 10 + "px";
              tooltipDiv.style.top = rect.top + "px";
              tooltipDiv.style.display = "block";
            }
            lastClickedNodeId = null;
          } else {
            tooltipDiv.style.display = "none";
          }
        },
        true
      );

      // Initialize Mermaid and render the diagram
      async function initializeAndRender() {
        try {
          console.log("Initializing Mermaid...");
          mermaid.initialize({
            startOnLoad: false,
            theme: document.body.classList.contains("vscode-dark")
              ? "dark"
              : "default",
            flowchart: {
              useMaxWidth: true,
              htmlLabels: true,
              curve: "basis",
              nodeSpacing: 50,
              rankSpacing: 50,
              diagramPadding: 50,
            },
            securityLevel: "loose",
            fontFamily: "var(--vscode-font-family)",
          });
          console.log("Mermaid initialized successfully");

          // Simply initialize Mermaid - the diagram should already be rendered
          await mermaid.init(undefined, mermaidContainer);
          console.log('Mermaid initialization complete');
          
          // Mark clickable nodes after a short delay
          setTimeout(markClickableNodes, 300);
        } catch (error) {
          console.error("Failed to initialize Mermaid:", error);
        }
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        // Check if we're running in VS Code or browser
        if (typeof acquireVsCodeApi === "function") {
          // In VS Code, initialize immediately
          initializeAndRender();
        } else {
          // In browser, show demo message
          mermaidContainer.innerHTML = 'This webview is designed to run in VS Code. Open a Python file and use the "Generate Python Flowchart" command.';
        }
      });
    </script>
  </body>
</html>
